name: Docker Image CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:

  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@master
    - name: Grant execute permission for gradlew
      run: chmod +x ./web/gradlew
    - name: Build Project
      run: ./web/gradlew build
    - name: Copy files to Server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SHH_USER }}
        port: ${{ secrets.SHH_PORT }}
        key: ${{ secrets.SHH_KEY }}
        source: "web/build/libs/web-0.0.1-SNAPSHOT.jar"
        target: "~/docker/btorres.dev"
        strip_components: 1
    - name: Build the Docker image
      run: docker build . --file web/Dockerfile --build-arg JAR_FILE=web/build/libs/\*.jar -t btorres.dev
  
